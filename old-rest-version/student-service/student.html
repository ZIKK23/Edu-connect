<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>EduConnect â€“ Daftar Siswa</title>
  <link rel="stylesheet" href="student.css" />
</head>
<body data-api-base="http://localhost:4000/gateway/users">
  <header class="topbar">
    <a class="brand" href="../dashboard.html">EduConnect</a>
    <nav>
      <a href="../index.html">Beranda</a>
      <a href="student.html" class="active">Daftar Siswa</a>
      <a href="../course-service/course.html">Daftar Kursus</a>
    </nav>
  </header>

  <main class="wrapper">
    <section class="card">
      <div class="card-header">
        <div>
          <h1>ğŸ‘©â€ğŸ“ Daftar Siswa (Student Service)</h1>
          <p>Menampilkan data siswa yang sudah tersimpan di database kampus.</p>
        </div>
        <button class="btn-reload" type="button">Muat Ulang</button>
      </div>

      <div class="form-card">
        <div class="form-header">
          <h2 id="form-title">Tambah Siswa Baru</h2>
          <p>Gunakan formulir ini untuk menambah atau memperbarui data siswa langsung ke database.</p>
        </div>
        <form id="student-form">
          <div class="form-grid">
            <label class="input-group">
              <span>Nama Lengkap</span>
              <input type="text" id="name" placeholder="Mis. Dina Rahma" required />
            </label>
            <label class="input-group">
              <span>Email Kampus</span>
              <input type="email" id="email" placeholder="nama@educonnect.id" required />
            </label>
          </div>
          <div class="form-actions">
            <button class="btn-primary" type="submit" id="submit-btn">Simpan</button>
            <button class="btn-secondary" type="button" id="cancel-edit" hidden>Batalkan Edit</button>
          </div>
        </form>
      </div>

      <p class="status-message" id="student-status" role="status"></p>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Nama</th>
              <th>Email</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="student-table-body">
            <tr>
              <td colspan="4" class="text-center">Memuat data siswa...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    (() => {
      const API_BASE =
        document.body.dataset.apiBase || 'http://localhost:4000/gateway/users';

      const tableBody = document.getElementById('student-table-body');
      const statusBox = document.getElementById('student-status');
      const reloadBtn = document.querySelector('.btn-reload');
      const form = document.getElementById('student-form');
      const nameInput = document.getElementById('name');
      const emailInput = document.getElementById('email');
      const submitBtn = document.getElementById('submit-btn');
      const cancelBtn = document.getElementById('cancel-edit');
      const formTitle = document.getElementById('form-title');

      let editingId = null;
      let students = [];

      const setStatus = (message = '', type = 'info') => {
        statusBox.textContent = message;
        statusBox.dataset.type = message ? type : '';
      };

      const setFormMode = (student = null) => {
        if (student) {
          editingId = student.id;
          nameInput.value = student.name;
          emailInput.value = student.email;
          submitBtn.textContent = 'Perbarui';
          formTitle.textContent = 'Edit Data Siswa';
          cancelBtn.hidden = false;
        } else {
          editingId = null;
          form.reset();
          submitBtn.textContent = 'Simpan';
          formTitle.textContent = 'Tambah Siswa Baru';
          cancelBtn.hidden = true;
        }
      };

      const renderStudents = () => {
        if (!students.length) {
          tableBody.innerHTML =
            '<tr><td colspan="4" class="text-center">Belum ada data siswa.</td></tr>';
          return;
        }

        tableBody.innerHTML = students
          .map(
            (student) => `
          <tr>
            <td>${student.id}</td>
            <td>${student.name}</td>
            <td>${student.email}</td>
            <td class="actions">
              <button type="button" class="btn-table btn-edit" data-id="${student.id}">Edit</button>
              <button type="button" class="btn-table btn-delete" data-id="${student.id}">Hapus</button>
            </td>
          </tr>
        `
          )
          .join('');
      };

      const fetchStudents = async () => {
        setStatus('Memuat data siswa...', 'info');
        try {
          const response = await fetch(API_BASE);
          if (!response.ok) {
            throw new Error(`Gagal memuat data (${response.status})`);
          }
          students = await response.json();
          renderStudents();
          setStatus(`Berhasil memuat ${students.length} siswa.`, 'success');
        } catch (error) {
          console.error(error);
          setStatus(error.message, 'error');
        }
      };

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const payload = {
          name: nameInput.value.trim(),
          email: emailInput.value.trim()
        };

        if (!payload.name || !payload.email) {
          setStatus('Nama dan email wajib diisi.', 'error');
          return;
        }

        try {
          submitBtn.disabled = true;
          const url = editingId ? `${API_BASE}/${editingId}` : API_BASE;
          const method = editingId ? 'PUT' : 'POST';
          const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const data = await response.json().catch(() => ({}));
            throw new Error(data.message || 'Operasi gagal dijalankan');
          }

          setStatus(
            editingId ? 'Data siswa berhasil diperbarui.' : 'Siswa baru berhasil ditambahkan.',
            'success'
          );
          await fetchStudents();
          setFormMode(null);
        } catch (error) {
          console.error(error);
          setStatus(error.message, 'error');
        } finally {
          submitBtn.disabled = false;
        }
      });

      cancelBtn.addEventListener('click', () => setFormMode(null));
      reloadBtn.addEventListener('click', fetchStudents);

      tableBody.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-id]');
        if (!button) return;
        const { id } = button.dataset;

        if (button.classList.contains('btn-edit')) {
          const student = students.find((item) => String(item.id) === String(id));
          if (student) {
            setFormMode(student);
          }
          return;
        }

        if (button.classList.contains('btn-delete')) {
          const confirmation = confirm('Hapus siswa ini secara permanen?');
          if (!confirmation) return;

          try {
            setStatus('Menghapus data siswa...', 'info');
            const response = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
            if (!response.ok && response.status !== 204) {
              const data = await response.json().catch(() => ({}));
              throw new Error(data.message || 'Gagal menghapus data siswa');
            }
            setStatus('Siswa berhasil dihapus.', 'success');
            await fetchStudents();
          } catch (error) {
            console.error(error);
            setStatus(error.message, 'error');
          }
        }
      });

      fetchStudents();
    })();
  </script>
</body>
</html>
