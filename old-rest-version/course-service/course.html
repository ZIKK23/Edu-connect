<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>EduConnect â€“ Daftar Kursus</title>
  <link rel="stylesheet" href="course.css" />
</head>
<body data-api-base="http://localhost:4000/gateway/courses">
  <header class="topbar">
    <a class="brand" href="../dashboard.html">EduConnect</a>
    <nav>
      <a href="../index.html">Beranda</a>
      <a href="../student-service/student.html">Daftar Siswa</a>
      <a href="course.html" class="active">Daftar Kursus</a>
    </nav>
  </header>

  <main class="wrapper">
    <section class="card">
      <div class="card-header">
        <div>
          <h1>ðŸ“š Daftar Kursus (Course Service)</h1>
          <p>Daftar mata kuliah aktif yang dikirim oleh Course Service.</p>
        </div>
        <button class="btn-reload" type="button">Muat Ulang</button>
      </div>

      <div class="form-card">
        <div class="form-header">
          <h2 id="course-form-title">Tambah Kursus Baru</h2>
          <p>Tulis detail mata kuliah yang ingin ditambahkan atau diperbarui.</p>
        </div>
        <form id="course-form">
          <div class="form-grid">
            <label class="input-group">
              <span>Judul Kursus</span>
              <input type="text" id="title" placeholder="Mis. Analisis Data" required />
            </label>
            <label class="input-group">
              <span>Kredit (SKS)</span>
              <input type="number" id="credits" min="1" max="10" placeholder="3" required />
            </label>
            <label class="input-group">
              <span>Nama Dosen</span>
              <input type="text" id="lecturer" placeholder="Dr. Nirmala Sari" required />
            </label>
          </div>
          <div class="form-actions">
            <button class="btn-primary" type="submit" id="course-submit-btn">Simpan</button>
            <button class="btn-secondary" type="button" id="course-cancel-edit" hidden>Batalkan Edit</button>
          </div>
        </form>
      </div>

      <p class="status-message" id="course-status" role="status"></p>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Judul Kursus</th>
              <th>Kredit</th>
              <th>Dosen</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="course-table-body">
            <tr>
              <td colspan="5" class="text-center">Memuat daftar kursus...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    (() => {
      const API_BASE =
        document.body.dataset.apiBase || 'http://localhost:4000/gateway/courses';

      const tableBody = document.getElementById('course-table-body');
      const statusBox = document.getElementById('course-status');
      const reloadBtn = document.querySelector('.btn-reload');
      const form = document.getElementById('course-form');
      const titleInput = document.getElementById('title');
      const creditsInput = document.getElementById('credits');
      const lecturerInput = document.getElementById('lecturer');
      const submitBtn = document.getElementById('course-submit-btn');
      const cancelBtn = document.getElementById('course-cancel-edit');
      const formTitle = document.getElementById('course-form-title');

      let editingId = null;
      let courses = [];

      const setStatus = (message = '', type = 'info') => {
        statusBox.textContent = message;
        statusBox.dataset.type = message ? type : '';
      };

      const setFormMode = (course = null) => {
        if (course) {
          editingId = course.id;
          titleInput.value = course.title;
          creditsInput.value = course.credits;
          lecturerInput.value = course.lecturer;
          submitBtn.textContent = 'Perbarui';
          formTitle.textContent = 'Edit Data Kursus';
          cancelBtn.hidden = false;
        } else {
          editingId = null;
          form.reset();
          submitBtn.textContent = 'Simpan';
          formTitle.textContent = 'Tambah Kursus Baru';
          cancelBtn.hidden = true;
        }
      };

      const renderCourses = () => {
        if (!courses.length) {
          tableBody.innerHTML =
            '<tr><td colspan="5" class="text-center">Belum ada kursus yang tersimpan.</td></tr>';
          return;
        }

        tableBody.innerHTML = courses
          .map(
            (course) => `
          <tr>
            <td>${course.id}</td>
            <td>${course.title}</td>
            <td>${course.credits} SKS</td>
            <td>${course.lecturer}</td>
            <td class="actions">
              <button type="button" class="btn-table btn-edit" data-id="${course.id}">Edit</button>
              <button type="button" class="btn-table btn-delete" data-id="${course.id}">Hapus</button>
            </td>
          </tr>
        `
          )
          .join('');
      };

      const fetchCourses = async () => {
        setStatus('Memuat daftar kursus...', 'info');
        try {
          const response = await fetch(API_BASE);
          if (!response.ok) {
            throw new Error(`Gagal memuat data (${response.status})`);
          }
          courses = await response.json();
          renderCourses();
          setStatus(`Berhasil memuat ${courses.length} kursus aktif.`, 'success');
        } catch (error) {
          console.error(error);
          setStatus(error.message, 'error');
        }
      };

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const payload = {
          title: titleInput.value.trim(),
          credits: Number(creditsInput.value),
          lecturer: lecturerInput.value.trim()
        };

        if (!payload.title || !payload.lecturer || Number.isNaN(payload.credits)) {
          setStatus('Semua field wajib diisi dengan benar.', 'error');
          return;
        }

        try {
          submitBtn.disabled = true;
          const url = editingId ? `${API_BASE}/${editingId}` : API_BASE;
          const method = editingId ? 'PUT' : 'POST';
          const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const data = await response.json().catch(() => ({}));
            throw new Error(data.message || 'Operasi gagal dijalankan');
          }

          setStatus(
            editingId ? 'Data kursus berhasil diperbarui.' : 'Kursus baru berhasil ditambahkan.',
            'success'
          );
          await fetchCourses();
          setFormMode(null);
        } catch (error) {
          console.error(error);
          setStatus(error.message, 'error');
        } finally {
          submitBtn.disabled = false;
        }
      });

      cancelBtn.addEventListener('click', () => setFormMode(null));
      reloadBtn.addEventListener('click', fetchCourses);

      tableBody.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-id]');
        if (!button) return;
        const { id } = button.dataset;

        if (button.classList.contains('btn-edit')) {
          const course = courses.find((item) => String(item.id) === String(id));
          if (course) {
            setFormMode(course);
          }
          return;
        }

        if (button.classList.contains('btn-delete')) {
          const confirmation = confirm('Hapus kursus ini dari katalog?');
          if (!confirmation) return;

          try {
            setStatus('Menghapus kursus...', 'info');
            const response = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
            if (!response.ok && response.status !== 204) {
              const data = await response.json().catch(() => ({}));
              throw new Error(data.message || 'Gagal menghapus kursus');
            }
            setStatus('Kursus berhasil dihapus.', 'success');
            await fetchCourses();
          } catch (error) {
            console.error(error);
            setStatus(error.message, 'error');
          }
        }
      });

      fetchCourses();
    })();
  </script>
</body>
</html>
